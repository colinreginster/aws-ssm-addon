name: "Build"
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-webext:
    name: "Build Web extension"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v1
      - name: "web-ext build"
        id: web-ext-build
        uses: kewisch/action-web-ext@v1
        with:
          cmd: build
          source: src/web-ext
          filename: "{name}-{version}.xpi"
          ignoreFiles: '[ "package.json","package-lock.json","yarn.lock" ]'
      - name: "web-ext sign"
        id: web-ext-sign
        uses: kewisch/action-web-ext@v1
        with:
          cmd: sign
          source: ${{ steps.web-ext-build.outputs.target }}
          channel: unlisted
          apiKey: ${{ secrets.AMO_SIGN_KEY }}
          apiSecret: ${{ secrets.AMO_SIGN_SECRET }}
          timeout: 900000

      - name: "Upload Artifact"
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: "aws-ssm-addon.xpi"
          path: ${{ steps.web-ext-build.outputs.target }}
  build-ps1:
    needs: build-webext
    name: "Build Binaries"
    runs-on: windows-latest
    if:  always() 
    steps:
      - name: "Checkout"
        uses: actions/checkout@v1
      - name: Install required PowerShell modules
        shell: powershell
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted;
          Install-Module ps2exe -ErrorAction Stop  -Repository PSGallery
      - name: fromPs1 to exe
        shell: powershell
        run: |
          Invoke-ps2exe ./src/ps1/wsl.ps1 ./wsl-wrapper.exe
      - name: "Upload Artifact"
        uses: actions/upload-artifact@v3
        with:
          name: "wsl-wrapper.exe"
          path: "./wsl-wrapper.exe"
  prepare-release:
    needs: build-ps1
    name: "Publish the release"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: autochangelog-action
        id: ac
        uses: rubenfiszel/autochangelog-action@v0.16.0
        with:
          manifest_file: "src/web-ext/manifest.json"
          dry_run: false
          issues_url_prefix: "https://github.com/org/repo/issues/"
          tag_prefix: ""
      - uses: avakar/tag-and-release@v1
        with:
          tag_name: ${{ steps.ac.outputs.version }}
      - uses: actions/download-artifact@v3
      - name: "Create Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            wsl-wrapper.exe
            aws-ssm-addon.xpi
